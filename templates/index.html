<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3連複期待値計算ツール</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<h1>3連複期待値計算ツール</h1>

<!-- 説明セクション -->
<div class="instructions">
  <h2>このツールの目的</h2>
  <p>
    このツールは、競馬の3連複馬券を対象に、<br>
    あなたが「3着以内に入らない」と思う馬を選び、<br>
    その馬を除外することで期待値がどう変わるかを計算するためのツールです。
  </p>
  <h3>使い方 (3つのステップ)</h3>
  <ol class="step-list">
    <li>出走頭数を入力し、<strong>次へ</strong>を押します。</li>
    <li>「3着以内に絶対入らない」と思う馬を選び、<strong>確信度 (%)</strong>を入力します。</li>
    <li>計算結果として、期待値と購入点数が表示されます。</li>
  </ol>
</div>

<hr>

<!-- 入力フォーム -->
<form method="POST">
  <input type="hidden" name="step" value="{{ step }}">

  {% if step == 0 %}
    <!-- ステップ0: 出走頭数入力 -->
    <div class="form-group">
      <label>出走頭数（10～18）：</label>
      <input type="number" name="total_horses" min="10" max="18" required>
    </div>
    <button type="submit">次へ</button>

  {% elif step == 1 and total_horses %}
    <!-- ステップ1: ウマ選択 + 確信度入力 + 結果表示 -->

    <!-- 出走頭数を保持 -->
    <input type="hidden" name="total_horses" value="{{ total_horses }}">

    <div class="form-group">
      <p class="current-horses">出走頭数: {{ total_horses }}</p>
      <label>除外する馬を選択:</label>
      <div class="horse-selection">
        {% for i in range(total_horses) %}
          {% set horse_number = i + 1 %}
          <label class="horse-checkbox">
            <input type="checkbox" name="excluded_horses" value="{{ horse_number }}"
            {% if horse_number|string in excluded_horses %}checked{% endif %}>
            {{ horse_number }}番
          </label>
        {% endfor %}
      </div>
    </div>

    <div class="form-group">
      <label>確信度(%)：</label>
      <input type="number" name="confidence" min="0" max="100"
             value="{{ confidence if confidence else '' }}" required>
      <span class="tooltip">※ 確信度は「選んだ馬が3着以内に来ない確率」です（例: 90%なら来ない自信が高い）</span>
    </div>

    <button type="submit">計算</button>

    {% if expected_value is not none %}
    <hr>
    <div class="results">
      <h2>計算結果</h2>
      <div class="result-item">
        <p>除外馬数: {{ excluded_horses|length }}</p>
        <p>確信度: {{ confidence }}%</p>
      </div>

      {% set purchase_count = total_horses|int - excluded_horses|length|int >= 3 and comb(total_horses|int - excluded_horses|length|int, 3) or 0 %}
      {% if purchase_count %}
        <div class="result-item">
          <p>購入する点数: <strong>{{ purchase_count }}</strong> 点</p>
          <p>すべての馬券を100円ずつ購入すると総額 <strong>{{ purchase_count * 100 }}円</strong> になります。</p>
        </div>
        <div class="result-item">
          <p>期待値: <strong>{{ expected_value|round(2) }}</strong></p>
          <p>例: 期待値が {{ expected_value|round(2) }} の場合、100円の馬券は <strong>{{ (expected_value * 100)|round(0) }}円</strong> のリターンになります。</p>
        </div>
      {% else %}
        <div class="result-item error">
          <p>購入する点数が無効です（除外馬が多すぎる可能性があります）。</p>
        </div>
      {% endif %}
    </div>
    {% endif %}
  {% endif %}
</form>

<hr>

<!-- 理論的な説明セクション -->
<div class="logic-section">
  <h2>なぜこの結果になるのか？</h2>
  <p>
    競馬の3連複では、<strong>出走頭数から3頭を選ぶ組み合わせ</strong>が対象となります。<br>
    例えば、18頭立てなら全体の組み合わせ数は <strong>816通り</strong> です。
  </p>
  <p>
    ここで「3着以内に絶対入らない」と思う馬を除外すると、<br>
    残りの馬の中から3頭を選ぶ組み合わせ数が減少し、期待値が変化します。
  </p>
  <p>
    期待値は次の計算式で求められます：
    <strong>期待値 = 確信度 × (総リターン ÷ 購入点数)</strong><br>
    - 総リターン: 競馬全体の控除率(約25%)を考慮したリターン（例: 0.75倍）<br>
    - 購入点数: 除外後の馬数から3頭を選ぶ組み合わせ数（C(馬数,3)）
  </p>
  <p>
    このツールでは、あなたの直感や確信度に基づき、<br>
    除外馬数と確信度が期待値に与える影響を計算し、表示します。
  </p>
</div>
</body>
</html>
