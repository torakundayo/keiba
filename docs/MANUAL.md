# ユーザーズマニュアル

**3連複 確率構造分析** の使い方ガイドです。

---

## 目次

1. [はじめに](#はじめに)
2. [トップページ](#トップページ)
3. [買い目分析](#買い目分析)
   - [レースの選択](#レースの選択)
   - [戦略比較テーブル](#戦略比較テーブル)
   - [組み合わせ一覧](#組み合わせ一覧)
   - [フィルター機能](#フィルター機能)
   - [カード表示 / テーブル表示](#カード表示--テーブル表示)
4. [計算方法](#計算方法)
5. [考察](#考察)
6. [検証（バックテスト）](#検証バックテスト)
7. [用語集](#用語集)
8. [よくある質問](#よくある質問)

---

## はじめに

このツールは、競馬の3連複について**確率構造を可視化**するための教育的ツールです。

### このツールでできること

- 単勝・複勝オッズから3連複の各組み合わせの**的中確率**と**期待回収率**を推定
- 確率順に組み合わせをランク付けし、上位の組み合わせを確認
- 購入点数ごとの的中率・回収率のトレードオフを比較
- バックテスト結果（774レース）で確率モデルの精度を検証

### このツールでできないこと

- **利益の保証**: 控除率25%のため、どの戦略でも長期的な回収率は75%以下です
- **未来の予測**: オッズに織り込まれた情報を超える予測はできません
- **購入の推奨**: 購入はすべて自己責任で行ってください

---

## トップページ

![トップページ](../public/images/top.png)

アクセスすると最初に表示される画面です。

- **ツールの目的**: 確率構造の可視化と損失最小化の判断材料提供
- **注意書き**: 利益を保証しないことを明記
- **ページリンク**: 4つのページ（買い目分析・計算方法・考察・検証）への導線
- **バックテスト概要**: 774レースの検証結果の要約

各ページのリンクカードをクリックすると、該当ページに遷移します。

---

## 買い目分析

実際のレースのオッズデータを使って確率構造を確認するページです。

### レースの選択

![レース選択画面](../public/images/analysis-select.png)

1. **日付を選択**: 画面上部の日付ボタンから開催日を選びます。JRAの開催日が自動的に表示されます。
2. **レースを選択**: 各競馬場（東京・京都・小倉など）のレースボタンをクリックします。重賞レースにはレース名が表示されます。
3. **データ読み込み**: レースを選択すると、keibalab.jpから最新のオッズデータを取得して分析を実行します。

### 戦略比較テーブル

![分析結果](../public/images/analysis-result.png)

レースを選択すると、まず**戦略比較テーブル**が表示されます。

| 列名 | 説明 |
|------|------|
| 買い方 | Top 3 / Top 5 / Top 10 / Top 20（確率上位N通りを購入） |
| 点数 | 購入する組み合わせの数 |
| 投資額 | 各100円で購入した場合の合計投資額 |
| モデル的中率 | 確率モデルから推定した的中率 |
| モデル回収率 | 確率モデルから推定した期待回収率 |
| 実績的中率 | バックテスト（774レース）の実際の的中率 |
| 実績回収率 | バックテストの実際の回収率 |

**読み方のポイント**:
- 点数が少ないほど回収率が高く、多いほど的中率が高い
- 実績回収率はすべて100%を下回る（利益は出ない）
- 「損失を最小化する」なら少数精鋭（Top 3〜5）が合理的

### 組み合わせ一覧

戦略比較テーブルの下に、全組み合わせが確率順にランク付けされて表示されます。

| 列名 | 説明 |
|------|------|
| 順位 | 確率モデルによる確率順位（1位が最も的中確率が高い） |
| 組合せ | 馬番の3頭の組み合わせ（例: 5-6-8） |
| 確率 | 推定的中確率（%） |
| 期待回収率 | 100円購入時の期待回収額の割合。100%超なら「有利な組み合わせ」 |
| 予想オッズ | 単勝オッズから推定した3連複オッズ |

### フィルター機能

組み合わせ一覧の上部にフィルターボタンがあります。

- **全て**: すべての組み合わせを表示
- **Top 3**: 上位3通りのみ
- **Top 5**: 上位5通りのみ
- **Top 10**: 上位10通りのみ
- **Top 20**: 上位20通りのみ

### カード表示 / テーブル表示

画面右上の「カード表示」ボタンで、テーブル形式とカード形式を切り替えできます。
モバイル端末ではカード表示が見やすいです。

### 出走馬情報

「出走馬」セクションでは、各馬の単勝オッズ・複勝オッズ・推定1着確率・推定3着以内確率を確認できます。

---

## 計算方法

![計算方法ページ](../public/images/explanation.png)

確率モデルの数学的な仕組みを解説するページです。

### 主な内容

1. **JRAのオッズの仕組み（パリミュチュエル方式）**
   - 購入者の投票総額から控除率を引いた残りが配当原資
   - 馬券種ごとの控除率（単勝20%、3連複25%など）

2. **なぜ2つのオッズを使うのか**
   - 単勝オッズ: 「1着確率」を反映（価格モデル）
   - 複勝オッズ: 「3着以内確率」を反映（確率モデル）
   - 同一モデルだと回収率が75%に固定される数学的証明

3. **具体例で理解する**
   - 3頭の馬（A/B/C）の具体的な数値を使った計算例
   - オッズ → 確率 → 組み合わせ確率 → 期待回収率の流れ

4. **計算手順の詳細**
   - Step 1: 単勝オッズから各馬の1着確率を推定
   - Step 2: 複勝オッズから各馬の3着以内確率を推定
   - Step 3: Harvilleモデルで着順確率を推定
   - Step 4: 期待回収率の算出

5. **補正: 複勝オッズがない場合（Harvilleモデル）**
   - 少頭数のレースで複勝オッズが取得できない場合のフォールバック

---

## 考察

![考察ページ](../public/images/insight.png)

バックテスト結果の解釈と理論的背景を深掘りするページです。

### 主な内容

1. **バックテストの結果**
   - 確率ランキングの有効性（ランダムの14倍の精度）
   - しかし利益は出ない

2. **なぜ利益が出ないのか: 市場効率仮説**
   - オッズにすべての公開情報が織り込まれている
   - 構造的な75%の壁

3. **なぜ単一モデルでは回収率が固定されるか**
   - 数式による証明（確率とオッズが相殺）

4. **2データソースアプローチ**
   - 単勝×複勝で75%からのズレを生み出す仕組み

5. **「それでも勝てる方法があるのでは？」**
   - AI・機械学習について
   - オッズ変動タイミングについて
   - プロ予想家について（生存者バイアス）
   - 非公開情報（インサイダー）について

6. **他のギャンブルとの比較**
   - 宝くじ（控除率55%）、パチンコ（10〜15%）、カジノ（0.5〜5%）との比較表

7. **よくある非効率な買い方**
   - 「絞れないからボックスで広げる」→ 回収率を下げるだけ
   - 「的中率を上げれば勝てる」→ 損失額が増える
   - 「人気馬同士のボックスなら堅い」→ 配当が低すぎる
   - 「大穴を狙えば一発で取り戻せる」→ 累積損失が上回る

8. **ギャンブルの認知バイアス**
   - 損失回避バイアス（プロスペクト理論）
   - ニアミス効果
   - サンクコストの誤謬
   - ギャンブラーの誤謬
   - 確証バイアス

9. **このツールの最適な使い方**

---

## 検証（バックテスト）

![検証ページ](../public/images/backtest.png)

774レースの実データで確率モデルを検証した結果を表示するページです。

### 主な内容

1. **Top-N戦略別パフォーマンス**
   - Top 1 〜 Top 20 の各戦略について、的中数・的中率・平均配当・回収率を比較

2. **回収率の内訳（Top 1戦略）**
   - 総投資額・的中回数・平均配当・総回収額・損失額の具体的な数字
   - なぜ的中しても利益が出ないかの解説

3. **10レース購入シミュレーション**
   - 的中0回のケース（最も起こりやすい）
   - 的中1回のケース
   - 短期的なブレの大きさ

4. **購入点数と回収率・的中率のグラフ**
   - 点数を増やすと的中率は上がるが回収率は下がる
   - 限界効用逓減の視覚的な確認

5. **なぜ点数を増やすと回収率が下がるのか**
   - 上位の組み合わせほど「投資対効果」が良い
   - 下位の追加は全体の回収率を引き下げる

6. **的中組合せの順位分布**
   - 中央値・25%点・75%点・最上位・最下位のバーチャート
   - モデルの精度と限界の可視化

### データの読み方

- **回収率**: 総回収額 ÷ 総投資額 × 100。100%を超えると利益、下回ると損失
- **的中率**: 的中したレース数 ÷ 全レース数 × 100。的中率が高くても回収率が低いことがある
- **平均配当**: 的中時に1枚（100円）あたりに受け取った金額の平均

---

## 用語集

| 用語 | 説明 |
|------|------|
| 3連複 | 1着・2着・3着の馬を順不同で当てる馬券。順番は問わない |
| 控除率 | JRAが売上から差し引く割合。3連複は25% |
| 払戻率 | 100% - 控除率。3連複は75% |
| 期待回収率 | 100円を投資した場合に期待できる回収額の割合 |
| パリミュチュエル方式 | 購入者の投票総額から控除を引き、的中者で分配する方式 |
| 単勝オッズ | 1着を当てる馬券のオッズ |
| 複勝オッズ | 3着以内を当てる馬券のオッズ |
| Harvilleモデル | 1着確率から2着・3着の条件付き確率を推定する数学モデル |
| Top N戦略 | 確率上位N通りを各100円で購入する戦略 |
| 市場効率仮説 (EMH) | 公開情報がすべてオッズに反映されているとする仮説 |
| ボックス買い | 選んだ馬のすべての組み合わせを均等に購入する買い方 |

---

## よくある質問

### Q: このツールを使えば競馬で勝てますか？

**いいえ。** JRAの3連複の控除率は25%であり、オッズから導出したモデルでは構造的に75%の壁を超えられません。774レースのバックテストでも、最も良い戦略（Top 1）の回収率は47%でした。

### Q: なぜ回収率が75%ではなく47%なのですか？

75%は「全組み合わせを均等に購入した場合」の理論値です。Top 1のように少数に絞ると、的中率が低い（8.4%）ため、ほとんどのレースで回収0円となり、回収率は75%を下回ります。

### Q: 点数を増やせば的中率が上がりますか？

はい。しかし**回収率は下がります**。Top 3（的中率21.3%、回収率45%）→ Top 20（的中率56.1%、回収率31%）のように、的中率と回収率はトレードオフの関係にあります。

### Q: 期待回収率100%超の組み合わせを買えば利益が出ますか？

個別の組み合わせの期待回収率は100%を超えることがありますが、それは**的中した場合**の話です。的中確率が低いため、多くのレースでは外れて投資額を失います。長期的には回収率は75%前後に収束します。

### Q: データはどこから取得していますか？

keibalab.jp から各レースの単勝オッズと複勝オッズをリアルタイムで取得しています。取得はサーバーサイドで行われ、HTTPキャッシュにより外部サイトへの負荷を抑制しています。

### Q: バックテストデータを自分で更新できますか？

はい。以下のコマンドでバックテストを再実行できます:

```bash
npx tsx scripts/backtest-topn.ts
```

`public/data/backtest-topn-results.json` が更新されます。対象期間はスクリプト内で設定されています。

### Q: モバイル端末で使えますか？

はい。レスポンシブ対応しており、スマートフォンやタブレットでも利用できます。分析画面ではカード表示に切り替えると見やすくなります。
